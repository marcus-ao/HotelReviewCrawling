# é¡¹ç›®æ¶æ„ä¸æ–‡ä»¶æ¸…å•

æœ¬æ–‡æ¡£è¯¦ç»†åˆ—å‡ºäº†é¡¹ç›®çš„å®Œæ•´æ–‡ä»¶ç»“æ„å’Œæ¯ä¸ªæ–‡ä»¶çš„å†…å®¹æ¡†æ¶ï¼Œç”¨äºæŒ‡å¯¼åç»­çš„ä»£ç å®ç°ã€‚

## ğŸ“ å®Œæ•´ç›®å½•ç»“æ„

```
HotelReviewCrawing/
â”œâ”€â”€ config/                      # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ settings.py             # å…¨å±€é…ç½®
â”‚   â””â”€â”€ regions.py              # å¹¿å·åŠŸèƒ½åŒºé…ç½®
â”‚
â”œâ”€â”€ crawler/                     # çˆ¬è™«æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ hotel_list_crawler.py   # é…’åº—åˆ—è¡¨çˆ¬è™«
â”‚   â”œâ”€â”€ review_crawler.py       # è¯„è®ºçˆ¬è™«
â”‚   â””â”€â”€ anti_crawler.py         # åçˆ¬è™«æ¨¡å—
â”‚
â”œâ”€â”€ database/                    # æ•°æ®åº“æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ models.py               # ORMæ¨¡å‹
â”‚   â”œâ”€â”€ connection.py           # æ•°æ®åº“è¿æ¥
â”‚   â””â”€â”€ init_db.sql             # æ•°æ®åº“åˆå§‹åŒ–SQL
â”‚
â”œâ”€â”€ utils/                       # å·¥å…·æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ cleaner.py              # æ•°æ®æ¸…æ´—
â”‚   â”œâ”€â”€ validator.py            # æ•°æ®éªŒè¯
â”‚   â””â”€â”€ logger.py               # æ—¥å¿—é…ç½®
â”‚
â”œâ”€â”€ scheduler/                   # ä»»åŠ¡è°ƒåº¦æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ task_scheduler.py       # ä»»åŠ¡è°ƒåº¦å™¨
â”‚
â”œâ”€â”€ plans/                       # è®¾è®¡æ–‡æ¡£
â”‚   â”œâ”€â”€ README.md               # æ–‡æ¡£æ€»è§ˆ
â”‚   â”œâ”€â”€ 01_HTMLç»“æ„åˆ†æ.md
â”‚   â”œâ”€â”€ 02_æ•°æ®åº“Schemaè®¾è®¡.md
â”‚   â”œâ”€â”€ 03_çˆ¬å–æµç¨‹æ¶æ„.md
â”‚   â””â”€â”€ 04_ç»¼åˆå®æ–½æ–¹æ¡ˆ.md
â”‚
â”œâ”€â”€ logs/                        # æ—¥å¿—ç›®å½•
â”‚   â””â”€â”€ .gitkeep
â”‚
â”œâ”€â”€ data/                        # æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ raw/                    # åŸå§‹æ•°æ®
â”‚   â”‚   â””â”€â”€ .gitkeep
â”‚   â”œâ”€â”€ processed/              # å¤„ç†åæ•°æ®
â”‚   â”‚   â””â”€â”€ .gitkeep
â”‚   â””â”€â”€ exports/                # å¯¼å‡ºæ•°æ®
â”‚       â””â”€â”€ .gitkeep
â”‚
â”œâ”€â”€ tests/                       # æµ‹è¯•ç›®å½•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ test_crawler.py
â”‚
â”œâ”€â”€ .env.example                 # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ .gitignore                   # Gitå¿½ç•¥æ–‡ä»¶
â”œâ”€â”€ requirements.txt             # Pythonä¾èµ–
â”œâ”€â”€ main.py                      # ä¸»ç¨‹åºå…¥å£
â””â”€â”€ README.md                    # é¡¹ç›®è¯´æ˜
```

## ğŸ“„ æ–‡ä»¶å†…å®¹æ¡†æ¶

### 1. é…ç½®æ–‡ä»¶æ¨¡å— (config/)

#### config/__init__.py
```python
"""é…ç½®æ¨¡å—åˆå§‹åŒ–"""
from .settings import Settings
from .regions import GUANGZHOU_REGIONS

__all__ = ['Settings', 'GUANGZHOU_REGIONS']
```

#### config/settings.py
**åŠŸèƒ½**: å…¨å±€é…ç½®ç®¡ç†
**å†…å®¹**:
- æ•°æ®åº“è¿æ¥é…ç½®
- Chromeè°ƒè¯•ç«¯å£é…ç½®
- çˆ¬è™«å‚æ•°é…ç½®ï¼ˆå»¶è¿Ÿæ—¶é—´ã€é‡è¯•æ¬¡æ•°ç­‰ï¼‰
- æ—¥å¿—é…ç½®
- æ–‡ä»¶è·¯å¾„é…ç½®

**å…³é”®ç±»**:
- `Settings`: ä½¿ç”¨Pydanticçš„BaseSettingsç®¡ç†é…ç½®
- æ”¯æŒä».envæ–‡ä»¶è¯»å–é…ç½®

#### config/regions.py
**åŠŸèƒ½**: å¹¿å·åŠŸèƒ½åŒºé…ç½®
**å†…å®¹**:
- 6å¤§åŠŸèƒ½åŒºå®šä¹‰
- æ¯ä¸ªåŠŸèƒ½åŒºçš„å•†åœˆåˆ—è¡¨
- ä»·æ ¼æ¡£æ¬¡é…ç½®
- æ¯ä¸ªæ¡£æ¬¡çš„é‡‡æ ·æ•°é‡

**æ•°æ®ç»“æ„**:
```python
GUANGZHOU_REGIONS = {
    "CBDå•†åŠ¡åŒº": {
        "business_zones": [
            {"name": "ç æ±Ÿæ–°åŸ/äº”ç¾Šæ–°åŸå•†åœˆ", "code": "39584"},
            # ...
        ],
        "price_ranges": [
            {"level": "R2", "min": 100, "max": 300, "top_n": 4},
            # ...
        ]
    },
    # ...
}
```

### 2. çˆ¬è™«æ¨¡å— (crawler/)

#### crawler/__init__.py
```python
"""çˆ¬è™«æ¨¡å—åˆå§‹åŒ–"""
from .hotel_list_crawler import HotelListCrawler
from .review_crawler import ReviewCrawler
from .anti_crawler import AntiCrawler

__all__ = ['HotelListCrawler', 'ReviewCrawler', 'AntiCrawler']
```

#### crawler/hotel_list_crawler.py
**åŠŸèƒ½**: é…’åº—åˆ—è¡¨çˆ¬å–
**æ ¸å¿ƒç±»**: `HotelListCrawler`
**æ ¸å¿ƒæ–¹æ³•**:
- `crawl_by_region()`: æŒ‰åŠŸèƒ½åŒºçˆ¬å–
- `crawl_by_business_zone()`: æŒ‰å•†åœˆçˆ¬å–
- `crawl_by_price_level()`: æŒ‰ä»·æ ¼æ¡£æ¬¡çˆ¬å–
- `extract_hotel_info()`: æå–é…’åº—ä¿¡æ¯
- `save_to_database()`: ä¿å­˜åˆ°æ•°æ®åº“

**å…³é”®é€»è¾‘**:
- æ„é€ æœç´¢URL
- ç­‰å¾…é¡µé¢åŠ è½½æˆ–è°ƒç”¨AJAXæ¥å£
- æå–é…’åº—åŸºæœ¬ä¿¡æ¯
- å»é‡æ£€æŸ¥
- ä¿å­˜åˆ°æ•°æ®åº“

#### crawler/review_crawler.py
**åŠŸèƒ½**: è¯„è®ºçˆ¬å–
**æ ¸å¿ƒç±»**: `ReviewCrawler`
**æ ¸å¿ƒæ–¹æ³•**:
- `waterfall_crawl()`: ç€‘å¸ƒæµé‡‡é›†ç­–ç•¥
- `crawl_negative_pool()`: çˆ¬å–è´Ÿé¢è­¦ç¤ºæ± 
- `crawl_evidence_pool()`: çˆ¬å–é«˜è´¨é‡è¯æ®æ± 
- `crawl_latest_pool()`: çˆ¬å–æ—¶æ•ˆæ€§è¡¥å…¨æ± 
- `extract_review_data()`: æå–è¯„è®ºæ•°æ®
- `extract_star_score()`: æå–æ˜Ÿçº§è¯„åˆ†
- `save_to_database()`: ä¿å­˜åˆ°æ•°æ®åº“

**å…³é”®é€»è¾‘**:
- æ£€æŸ¥æ€»è¯„è®ºæ•°ï¼ˆ<50æ¡è·³è¿‡ï¼‰
- æŒ‰ä¼˜å…ˆçº§çˆ¬å–ä¸‰ä¸ªæ± 
- å»é‡æ£€æŸ¥ï¼ˆreview_idï¼‰
- æå–è¯„åˆ†ã€å†…å®¹ã€å›¾ç‰‡ç­‰
- ä¿å­˜åˆ°æ•°æ®åº“

#### crawler/anti_crawler.py
**åŠŸèƒ½**: åçˆ¬è™«ç­–ç•¥
**æ ¸å¿ƒç±»**: `AntiCrawler`
**æ ¸å¿ƒæ–¹æ³•**:
- `init_browser()`: åˆå§‹åŒ–æµè§ˆå™¨ï¼ˆæ¥ç®¡Chromeï¼‰
- `random_delay()`: éšæœºå»¶è¿Ÿ
- `check_and_handle_captcha()`: æ£€æŸ¥å¹¶å¤„ç†éªŒè¯ç 
- `auto_slide_captcha()`: è‡ªåŠ¨æ‹–æ‹½æ»‘å—
- `rotate_user_agent()`: è½®æ¢User-Agent

**å…³é”®é€»è¾‘**:
- è¿æ¥åˆ°Chromeè°ƒè¯•ç«¯å£
- æ™ºèƒ½å»¶è¿Ÿç­–ç•¥
- æ»‘å—éªŒè¯ç è‡ªåŠ¨å¤„ç†
- å¤±è´¥æ—¶äººå·¥ä»‹å…¥

### 3. æ•°æ®åº“æ¨¡å— (database/)

#### database/__init__.py
```python
"""æ•°æ®åº“æ¨¡å—åˆå§‹åŒ–"""
from .models import Hotel, Review, ReviewImage, ReviewReply, AspectOpinion, EmbeddingIndex
from .connection import get_session, init_db

__all__ = [
    'Hotel', 'Review', 'ReviewImage', 'ReviewReply', 
    'AspectOpinion', 'EmbeddingIndex',
    'get_session', 'init_db'
]
```

#### database/models.py
**åŠŸèƒ½**: ORMæ¨¡å‹å®šä¹‰
**æ ¸å¿ƒç±»**:
- `Hotel`: é…’åº—åŸºç¡€ä¿¡æ¯æ¨¡å‹
- `Review`: è¯„è®ºä¸»è¡¨æ¨¡å‹
- `ReviewImage`: è¯„è®ºå›¾ç‰‡æ¨¡å‹
- `ReviewReply`: å•†å®¶å›å¤æ¨¡å‹
- `AspectOpinion`: æ–¹é¢æƒ…æ„Ÿæ¨¡å‹
- `EmbeddingIndex`: å‘é‡ç´¢å¼•æ¨¡å‹
- `CrawlTask`: çˆ¬å–ä»»åŠ¡æ¨¡å‹
- `CrawlLog`: çˆ¬å–æ—¥å¿—æ¨¡å‹

**æŠ€æœ¯è¦ç‚¹**:
- ä½¿ç”¨SQLAlchemy ORM
- å®šä¹‰è¡¨å…³ç³»ï¼ˆå¤–é”®ã€çº§è”åˆ é™¤ç­‰ï¼‰
- å®šä¹‰ç´¢å¼•
- å®šä¹‰çº¦æŸ

#### database/connection.py
**åŠŸèƒ½**: æ•°æ®åº“è¿æ¥ç®¡ç†
**æ ¸å¿ƒå‡½æ•°**:
- `get_engine()`: è·å–æ•°æ®åº“å¼•æ“
- `get_session()`: è·å–æ•°æ®åº“ä¼šè¯
- `init_db()`: åˆå§‹åŒ–æ•°æ®åº“ï¼ˆåˆ›å»ºè¡¨ï¼‰
- `close_session()`: å…³é—­ä¼šè¯

**æŠ€æœ¯è¦ç‚¹**:
- è¿æ¥æ± ç®¡ç†
- ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
- å¼‚å¸¸å¤„ç†

#### database/init_db.sql
**åŠŸèƒ½**: æ•°æ®åº“åˆå§‹åŒ–SQLè„šæœ¬
**å†…å®¹**:
- åˆ›å»ºpgvectoræ‰©å±•
- åˆ›å»ºæ‰€æœ‰è¡¨
- åˆ›å»ºç´¢å¼•
- åˆ›å»ºè§†å›¾
- æ’å…¥åˆå§‹æ•°æ®ï¼ˆå¦‚æœéœ€è¦ï¼‰

**å‚è€ƒ**: è¯¦è§ [`plans/02_æ•°æ®åº“Schemaè®¾è®¡.md`](plans/02_æ•°æ®åº“Schemaè®¾è®¡.md)

### 4. å·¥å…·æ¨¡å— (utils/)

#### utils/__init__.py
```python
"""å·¥å…·æ¨¡å—åˆå§‹åŒ–"""
from .cleaner import clean_text, extract_tags
from .validator import ReviewModel, HotelModel
from .logger import setup_logger

__all__ = ['clean_text', 'extract_tags', 'ReviewModel', 'HotelModel', 'setup_logger']
```

#### utils/cleaner.py
**åŠŸèƒ½**: æ•°æ®æ¸…æ´—
**æ ¸å¿ƒå‡½æ•°**:
- `clean_text()`: æ¸…æ´—æ–‡æœ¬ï¼ˆå»HTMLã€è§„èŒƒåŒ–ç©ºç™½ï¼‰
- `extract_tags_from_comment_name()`: ä»è¯„è®ºæ ‡ç­¾ä¸­æå–æ ‡ç­¾
- `remove_emoji()`: ç§»é™¤æˆ–ä¿ç•™è¡¨æƒ…ç¬¦å·
- `normalize_whitespace()`: è§„èŒƒåŒ–ç©ºç™½å­—ç¬¦

#### utils/validator.py
**åŠŸèƒ½**: æ•°æ®éªŒè¯
**æ ¸å¿ƒç±»**:
- `HotelModel`: é…’åº—æ•°æ®éªŒè¯æ¨¡å‹ï¼ˆPydanticï¼‰
- `ReviewModel`: è¯„è®ºæ•°æ®éªŒè¯æ¨¡å‹ï¼ˆPydanticï¼‰

**éªŒè¯è§„åˆ™**:
- å¿…å¡«å­—æ®µæ£€æŸ¥
- æ•°æ®ç±»å‹æ£€æŸ¥
- æ•°å€¼èŒƒå›´æ£€æŸ¥ï¼ˆå¦‚è¯„åˆ†1-5ï¼‰
- å­—ç¬¦ä¸²é•¿åº¦æ£€æŸ¥

#### utils/logger.py
**åŠŸèƒ½**: æ—¥å¿—é…ç½®
**æ ¸å¿ƒå‡½æ•°**:
- `setup_logger()`: é…ç½®æ—¥å¿—ç³»ç»Ÿ

**æ—¥å¿—é…ç½®**:
- æ§åˆ¶å°è¾“å‡ºï¼ˆINFOçº§åˆ«ï¼‰
- æ–‡ä»¶è¾“å‡ºï¼ˆDEBUGçº§åˆ«ï¼ŒæŒ‰å¤©è½®è½¬ï¼‰
- é”™è¯¯æ—¥å¿—å•ç‹¬è®°å½•ï¼ˆERRORçº§åˆ«ï¼‰

### 5. ä»»åŠ¡è°ƒåº¦æ¨¡å— (scheduler/)

#### scheduler/__init__.py
```python
"""ä»»åŠ¡è°ƒåº¦æ¨¡å—åˆå§‹åŒ–"""
from .task_scheduler import TaskScheduler

__all__ = ['TaskScheduler']
```

#### scheduler/task_scheduler.py
**åŠŸèƒ½**: ä»»åŠ¡è°ƒåº¦ç®¡ç†
**æ ¸å¿ƒç±»**: `TaskScheduler`
**æ ¸å¿ƒæ–¹æ³•**:
- `schedule_hotel_list_crawl()`: è°ƒåº¦é…’åº—åˆ—è¡¨çˆ¬å–
- `schedule_review_crawl()`: è°ƒåº¦è¯„è®ºçˆ¬å–
- `create_task()`: åˆ›å»ºä»»åŠ¡
- `update_task_status()`: æ›´æ–°ä»»åŠ¡çŠ¶æ€
- `get_pending_tasks()`: è·å–å¾…æ‰§è¡Œä»»åŠ¡

**æŠ€æœ¯è¦ç‚¹**:
- ä½¿ç”¨APScheduler
- ä»»åŠ¡çŠ¶æ€ç®¡ç†
- ä»»åŠ¡é‡è¯•æœºåˆ¶
- ä»»åŠ¡ä¼˜å…ˆçº§

### 6. ä¸»ç¨‹åº (main.py)

**åŠŸèƒ½**: ç¨‹åºå…¥å£
**æ ¸å¿ƒåŠŸèƒ½**:
- å‘½ä»¤è¡Œå‚æ•°è§£æï¼ˆargparseï¼‰
- æ¨¡å¼é€‰æ‹©ï¼ˆtest/hotel_list/reviewsï¼‰
- åˆå§‹åŒ–å„æ¨¡å—
- å¯åŠ¨çˆ¬å–ä»»åŠ¡
- å¼‚å¸¸å¤„ç†
- è¿›åº¦æ˜¾ç¤º

**å‘½ä»¤è¡Œå‚æ•°**:
```bash
python main.py --mode [test|hotel_list|reviews] 
               --max-hotels [æ•°é‡]
               --max-reviews-per-hotel [æ•°é‡]
               --region [åŠŸèƒ½åŒºåç§°]
               --zone [å•†åœˆåç§°]
```

### 7. ä¾èµ–æ–‡ä»¶ (requirements.txt)

**æ ¸å¿ƒä¾èµ–**:
```
DrissionPage>=4.0.0
sqlalchemy>=2.0.0
psycopg2-binary>=2.9.0
pydantic>=2.0.0
loguru>=0.7.0
tqdm>=4.65.0
tenacity>=8.2.0
python-dotenv>=1.0.0
APScheduler>=3.10.0
beautifulsoup4>=4.12.0
```

### 8. ç¯å¢ƒå˜é‡ç¤ºä¾‹ (.env.example)

```env
# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=5432
DB_NAME=hotel_reviews
DB_USER=postgres
DB_PASSWORD=your_password

# Chromeè°ƒè¯•é…ç½®
CHROME_DEBUG_PORT=9222
CHROME_USER_DATA_DIR=C:/selenium/automation_profile

# çˆ¬è™«é…ç½®
MIN_DELAY=3
MAX_DELAY=6
MAX_RETRIES=3
REQUEST_TIMEOUT=30

# æ—¥å¿—é…ç½®
LOG_LEVEL=INFO
LOG_DIR=logs
```

### 9. Gitå¿½ç•¥æ–‡ä»¶ (.gitignore)

**å¿½ç•¥å†…å®¹**:
- Pythonç¼“å­˜æ–‡ä»¶ï¼ˆ__pycache__/ï¼‰
- è™šæ‹Ÿç¯å¢ƒï¼ˆvenv/ï¼‰
- ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼ˆ.envï¼‰
- æ—¥å¿—æ–‡ä»¶ï¼ˆlogs/*.logï¼‰
- æ•°æ®æ–‡ä»¶ï¼ˆdata/raw/*, data/processed/*ï¼‰
- IDEé…ç½®ï¼ˆ.vscode/, .idea/ï¼‰
- HTMLæºä»£ç æ–‡ä»¶ï¼ˆ*.htmï¼‰

## ğŸ”„ å®ç°é¡ºåºå»ºè®®

### é˜¶æ®µ1: åŸºç¡€è®¾æ–½ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰
1. âœ… åˆ›å»ºç›®å½•ç»“æ„
2. âœ… åˆ›å»ºREADME.md
3. â­ï¸ åˆ›å»º.gitignore
4. â­ï¸ åˆ›å»ºrequirements.txt
5. â­ï¸ åˆ›å»º.env.example

### é˜¶æ®µ2: æ•°æ®åº“æ¨¡å—ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰
1. â­ï¸ åˆ›å»ºdatabase/init_db.sql
2. â­ï¸ åˆ›å»ºdatabase/connection.py
3. â­ï¸ åˆ›å»ºdatabase/models.py

### é˜¶æ®µ3: é…ç½®æ¨¡å—ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰
1. â­ï¸ åˆ›å»ºconfig/settings.py
2. â­ï¸ åˆ›å»ºconfig/regions.py

### é˜¶æ®µ4: å·¥å…·æ¨¡å—ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰
1. â­ï¸ åˆ›å»ºutils/logger.py
2. â­ï¸ åˆ›å»ºutils/cleaner.py
3. â­ï¸ åˆ›å»ºutils/validator.py

### é˜¶æ®µ5: çˆ¬è™«æ¨¡å—ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰
1. â­ï¸ åˆ›å»ºcrawler/anti_crawler.py
2. â­ï¸ åˆ›å»ºcrawler/hotel_list_crawler.py
3. â­ï¸ åˆ›å»ºcrawler/review_crawler.py

### é˜¶æ®µ6: ä»»åŠ¡è°ƒåº¦ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰
1. â­ï¸ åˆ›å»ºscheduler/task_scheduler.py

### é˜¶æ®µ7: ä¸»ç¨‹åºï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰
1. â­ï¸ åˆ›å»ºmain.py

### é˜¶æ®µ8: æµ‹è¯•ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰
1. â­ï¸ åˆ›å»ºtests/test_crawler.py


## ğŸ”— ç›¸å…³æ–‡æ¡£

- [HTMLç»“æ„åˆ†æ](01_HTMLç»“æ„åˆ†æ.md)
- [æ•°æ®åº“Schemaè®¾è®¡](02_æ•°æ®åº“Schemaè®¾è®¡.md)
- [çˆ¬å–æµç¨‹æ¶æ„](03_çˆ¬å–æµç¨‹æ¶æ„.md)
- [ç»¼åˆå®æ–½æ–¹æ¡ˆ](04_ç»¼åˆå®æ–½æ–¹æ¡ˆ.md)
