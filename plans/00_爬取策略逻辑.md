### 爬取策略总纲

* **核心目标：** 构建一个**高信噪比、分布均衡、覆盖全面**的酒店推荐知识库，服务于RAG检索与轻量LLM微调。
* **采集原则：** 摒弃全量爬取的方式，采用<strong>“分层抽样” + “瀑布流采集”</strong>的方式进行爬取。
* **规模预估：** 约2GB左右
* **酒店样本：** 约 250 - 270 家（覆盖广州 6 大核心功能区，兼顾不同价位）。
* **评论样本：** 约 75,000 - 81,000 条（每家酒店约 300 条高质量去重数据，包含正负向情感打分与评论事实证据）。



---

### 阶段一：酒店候选集构建（解决“区域与价格偏差”）

此阶段目标是解决“幸存者偏差”问题，确保推荐系统既懂“CBD商业舱”也懂“大学城经济舱”。

#### 1. 区域分层

**选取广州市 6 类典型功能区，每类选 3 个代表性商圈作为搜索种子,每个代表性商圈选取 15 家左右酒店**：

| 区域类型 | 代表商圈/具体地标 | 典型价格区间 (RMB) | 用户画像 & 核心诉求 | 推荐系统覆盖场景 | RAG检索高频关键词 (Key Terms) | 细粒度方面关注点 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **CBD商务区** | 天河体育西、珠江新城、林和西（近东站）、太古汇 | 600 - 2000+ (中高端为主) | 商务精英/购物达人诉求：效率、排面、景观、便利 | “来广州出差，预算充裕，想住得舒服点，晚上能看小蛮腰夜景。” | 广州塔(小蛮腰)景观、地铁上盖、行政酒廊、豪华、浴缸、太古汇、天环广场 | 景观(View)、位置(Location)、设施(Facility - 办公桌/熨斗) |
| **老城文化区** | 北京路步行街、上下九步行街、沙面、永庆坊、陈家祠 | 300 - 1000 (跨度大，老牌五星+民宿) | 文化游客/吃货/文青诉求：地道美食、历史氛围、打卡 | “想体验老广州风情，出门就能喝早茶，最好是骑楼风格或老建筑。” | 早茶/陶陶居/点都德、骑楼、步行街、老字号、珠江夜游、拍照出片、复古 | 餐饮(Food)、周边(Surroundings - 历史感)、卫生(Hygiene - ⚠️老房虫鼠问题) |
| **交通枢纽区** | 广州南站、白云机场、广州火车站 | 200 - 600 (经济快捷为主) | 中转旅客/赶车族诉求：不误点、免费接送、安静睡觉 | “明天一早7点的飞机/高铁，推荐个能免费接送的酒店，别太吵。” | 免费接送机/站、叫醒服务、离进站口近、隔音好、24小时前台 | 服务(Service - 接送)、噪音(Noise - 飞机/火车声)、位置(Location - 直线距离) |
| **会展/活动区** | 琶洲会展中心、海珠广场、广州塔附近 | 平时400/展期1500+ (波动极大) | 参展商/看展观众诉求：步行直达、展期不涨价太离谱 | “要去广交会/漫展，不想挤地铁，推荐个步行能到场馆的酒店。” | 广交会/保利世贸、步行可达、展馆对面、商务中心、早餐早开 | 位置(Location - 步行距离)、价格(Price - 溢价接受度)、网络(Wifi - 办公) |
| **度假/亲子区** | 长隆旅游度假区、从化温泉、增城白水寨 | 800 - 3000+ (溢价高) | 家庭亲子/情侣度假诉求：孩子开心、一站式躺平 | “带两个娃去长隆看动物，要有亲子主题房，最好有儿童乐园。” | 野生动物世界/大马戏、亲子房、儿童牙刷/拖鞋、接驳车、私汤/温泉、无边泳池 | 设施(Facility - 亲子/泳池)、服务(Service - 响应速度)、卫生(Hygiene - 床品) |
| **高校/科技区** | 大学城、科学城、智慧城 | 200 - 500 (高性价比) | 考研学生/家长/IT从业者诉求：安静、便宜、近考点/园区 | “去大学城考试/送孩子上学，找个安静干净的，性价比高点。” | 中山大学/华工、考研房、安静、网易/小鹏总部、干净卫生 | 噪音(Noise - 备考)、价格(Price - 预算敏感)、网络(Wifi) |


#### 2. 价格分层

在上述每个商圈内，分别执行 **4 次独立搜索**，强制覆盖不同价位：

* **搜索动作矩阵（每个商圈15家左右酒店）：**
1. **经济型 (0-300元):** 采集 Top 4（按**评分**排序，防止脏乱差）。
2. **舒适型 (300-600元):** 采集 Top 6（按**销量**排序，取大众主流）。
3. **高档型 (600-1200元):** 采集 Top 3（按**销量**排序）。
4. **奢华型 (1200元+):** 采集 Top 2（按**综合**排序，取顶级体验）。


* **弹性补位机制：** 若某商圈某价位（如CBD的0-300元）数量不足，则将剩余配额转移至相邻价位档。

#### 3. 静态数据解析

针对每个选中的酒店，解析其 **JSON 数据源 (`HotelSearch.init`)**，提取关键字段解决“无价格”问题：

* **Hotel_ID / Name / Address**
* **Base_Price:** 取 `data.hotelPrice` (基准价)。
* **Price_Range:** 遍历 `data.sroomTypes` 计算 (如 "450-800")，生成 `Price_Level` 标签。
* **Lat/Long:** 经纬度（用于计算距离）。

---

### 阶段二：评论详情采集（解决“数据重叠与长尾分布”）

此阶段目标是解决“好评全是废话”和“数据重复”问题。针对每一家选中的酒店，执行以下 **瀑布流** 逻辑。

**目标配额：每家酒店 Max 300 条 (注意去除商家回复评论的内容,仅提取用户评论内容)。**

#### 步骤 1：负面警示池 (Negative Pool) —— **优先级最高**

* **筛选条件：** 标签选“差评(1-2分)” + “中评(3分)”。
* **排序：** 按时间（最新）。
* **采集量：** 上限 **100条**（不足 100 则全取）。
* **目的：** 挖掘“隔音差”、“卫生死角”等具体缺陷。
* **动作：** 存入数据库，记录 `Review_ID` 到去重集合。

#### 步骤 2：高质量证据池 (Evidence Pool) —— **优先级次之**

* **筛选条件：** 标签选“有图/视频”。
* **排序：** 按时间（最新）。
* **采集量：** 上限 **150条**。
* **去重逻辑：** 爬取时检测 `Review_ID`。如果已在“步骤1”中存在（即带图的差评），则**跳过**；否则存入。
* **目的：** 有图评论通常包含设施细节（床软硬、早餐种类），是 RAG 检索“环境描述”的最佳素材。

#### 步骤 3：时效性补全池 (Latest Pool) —— **优先级最低**

* **筛选条件：** 标签选“全部”。
* **排序：** 按时间（最新）。
* **采集量：** **填满剩余配额**（Target 300 - 已采数量）。
* **去重逻辑：** 检查 `Review_ID` 是否在“步骤1”或“步骤2”中存在？若存在则跳过。
* **目的：** 确保模型知道酒店“最近一周/一月”的状态。

#### 步骤 4：长尾熔断机制 (Circuit Breaker)

* **前置检查：** 进入页面前，读取总评论数。
* 若 `Total_Count < 50`：**直接放弃该酒店**（信息密度过低，易产生幻觉）。
* 若 `Total_Count` 在 50-300 之间：全量爬取。



---

### 阶段三：细粒度字段映射

为了支撑 PyABSA 分析和 RAG 检索，爬虫需精准提取以下字段（主要基于 JSON 数据岛解析）：

| 字段名 | 来源 (基于飞猪HTML/JSON) | 说明 |
| --- | --- | --- |
| **review_id** | HTML 属性 | **唯一主键**，用于去重。 |
| **content** | `.tb-r-cnt` | 纯文本清洗（去表情、去HTML标签）。 |
| **create_time** | `.tb-r-date` | 转换为标准 `YYYY-MM-DD` 格式。 |
| **room_type** | AJAX/JSON 字段 | 房型名称（如“江景房”），辅助 RAG 过滤。 |
| **score_clean** | `.starscore` -> 清洁程度 | 解析 `width: X%` 转换为 1-5 分。 |
| **score_service** | `.starscore` -> 服务体验 | 同上。 |
| **score_value** | `.starscore` -> **性价比** | **关键字段**。替代具体价格，回答“值不值”。 |
| **tags** | `.review-tag` | 提取“位置好”、“服务热情”等标签。 |

---

### 技术栈与反爬机制应对方案

本方案放弃传统的 Selenium/Requests，采用 **"浏览器接管 + 新一代自动化工具 + 人机协同"** 的组合拳。

#### 1. 核心框架选择

* **控制端：** **Python + DrissionPage**
* *理由：* DrissionPage 直接操作浏览器底层协议 (CDP)，不像 Selenium 那样携带 `webdriver` 特征，能有效绕过飞猪的自动化检测。


* **浏览器端：** **Google Chrome (开启远程调试端口)**
* **数据存储：** `PostgreSQL` (生产阶段，支持 pgvector)。

#### 2. 攻克难点一：强制登录验证

* **解决方案：Debug Port 接管模式**
* **操作流程：**
1. **手动启动：** 使用命令行启动 Chrome：`chrome.exe --remote-debugging-port=9222 --user-data-dir="C:\selenum\automation_profile"`。
2. **人工登录：** 在打开的浏览器中，**手动扫码登录**飞猪账号，直至进入首页。
3. **代码接管：** Python 脚本连接该端口，继承登录后的 Cookies 和 Session。


* *代码片段：*
```python
from DrissionPage import ChromiumPage
# 连接已打开的浏览器，无需再次登录
page = ChromiumPage(addr_or_opts='127.0.0.1:9222')

```





#### 3. 攻克难点二：翻页滑块验证

* **解决方案：DrissionPage 拟人操作 + 异常中断人工介入**
* **策略逻辑：**
1. **随机等待：** 翻页前 `random.uniform(3, 6)` 秒，模拟人类阅读。
2. **自动尝试：** 监测到滑块 (`#nc_1_n1z`) 后，使用 DrissionPage 的 `hold()` 和 `move()` 方法模拟拖拽。
3. **人工兜底：** 如果自动拖拽失败（页面未跳转或报错），程序**挂起并报警**提醒人工进行验证。
